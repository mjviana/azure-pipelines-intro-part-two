pool:
  vmImage: ubuntu-latest
stages:
  - stage: ci
    displayName: Continuous Integration
    jobs:
    - job: build
      displayName: Build Project Assets
      container: mcr.microsoft.com/dotnet/sdk:6.0
      steps:
      - script: |
          dotnet publish \
          --configuration Release \
          --output out \
          --self-contained \
          --runtime win-x64 \
          -p:EnableCompressionInSingleFile=true \
          -p:PublishSingleFile=true \
          -P:PublishReadyToRun=true \
          -p:DebugType=embedded 
        displayName: Publish .NET console Project
      - publish: out/Mjv.Azure.Pipelines.Intro.exe
        displayName: Upload console app artifact
        artifact: console-app
      - script: |
          dotnet pack \
          --output pkg \
          -p:Version=1.0.0
        displayName: Package dotnet tool
      - publish: pkg/Mjv.Azure.Pipelines.Intro.1.0.0.nupkg
        displayName: Upload package artifact
        artifact: nuget-package
    - job: release
      displayName: Release on NuGet
      dependsOn: build
      container: mcr.microsoft.com/dotnet/sdk:6.0
      steps:
        - download: current
          displayName: Download package artifact
          artifact: nuget-package
        - script: |
            dotnet nuget push \
            pkg/Mjv.Azure.Pipelines.Intro.1.0.0.nupkg \
            --skip-duplicate \
            --api-key $(nuget-api-key) \
            --source https://api.nuget.org/v3/index.json
          displayName: Push to NuGet.org
          workingDirectory: $(Pipeline.Workspace)/nuget-package
